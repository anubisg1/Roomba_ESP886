<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Roomba: RoombaRCRxESP8266/RoombaRCRxESP8266.ino</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Roomba
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">RoombaRCRxESP8266/RoombaRCRxESP8266.ino</div>  </div>
</div><!--header-->
<div class="contents">
<p>Sample RCRx RCOIP receiver for driving a Create Receives RCOIP commmands on a ESP8266 and uses them to control the wheel motors on a Create Uses the driveDirect command so cant be used on <a class="el" href="classRoomba.html" title="Support for iRobot Roomba and Create platforms via serial port using the iRobot Open Interface (OI) p...">Roomba</a></p>
<div class="fragment"><div class="line">// RCRx</div><div class="line">//</div><div class="line">// Sample RCRx RCOIP receiver for driving a Create</div><div class="line">// Receives RCOIP commmands on a ESP8266 and uses them to control the wheel motors on a Create</div><div class="line">// Uses the driveDirect command so cant be used on Roomba</div><div class="line">//</div><div class="line">// This simple example handles 2 RCOIP receiver channels.</div><div class="line">//</div><div class="line">// This can be used off the shelf with the RCTx transmitter app for iPhone</div><div class="line">// Copyright (C) 2010 Mike McCauley</div><div class="line"></div><div class="line">#include &lt;ESP8266Transceiver.h&gt;</div><div class="line">#include &lt;RCRx.h&gt;</div><div class="line">#include &lt;Servo.h&gt;</div><div class="line">//#include &quot;AnalogSetter.h&quot;</div><div class="line">//#include &quot;HBridgeSetter.h&quot;</div><div class="line">#include &quot;DifferentialSetter.h&quot;</div><div class="line">#include &quot;DigitalSetter.h&quot;</div><div class="line">#include &quot;AccelStepper.h&quot;</div><div class="line">#include &quot;SetterDebug.h&quot;</div><div class="line">#include &quot;Roomba.h&quot;</div><div class="line"></div><div class="line">// Declare the receiver object. It will handle messages received from the</div><div class="line">// transceiver and turn them into channel outputs.</div><div class="line">// The receiver and transceiver obects are connected together during setup()</div><div class="line">RCRx rcrx;</div><div class="line"></div><div class="line">// Declare the Roomba controller on the default port Serial</div><div class="line">Roomba roomba(&amp;Serial);</div><div class="line"></div><div class="line">// Declare the transceiver object, in this case the built-in ESP8266 WiFi</div><div class="line">// transceiver.</div><div class="line">// Note: other type of transceiver are supported by RCRx</div><div class="line">// It will create a WiFi Access Point with SSID of &quot;RCArduino&quot;, that you can connect to with the </div><div class="line">// password &quot;xyzzyxyzzy&quot;</div><div class="line">// on channel 1</div><div class="line">// The default IP address of this transceiver is 192.168.4.1/24</div><div class="line">// These defaults can be changed by editing ESP8266Transceiver.cpp</div><div class="line">// The reported RSSI is in dBm above -60dBm</div><div class="line">// If you are using the RCTx transmitter app for iPhone</div><div class="line">// dont forget to set the destination IP address in the RCTx transmitter app profile</div><div class="line">ESP8266Transceiver transceiver;</div><div class="line"></div><div class="line">// We use SetterDebug so we can extract the output values from them during the polling loop</div><div class="line">SetterDebug left;</div><div class="line">SetterDebug right;</div><div class="line">DifferentialSetter ds1(&amp;right, &amp;left);</div><div class="line">DifferentialLRSetter di1(&amp;ds1);</div><div class="line"></div><div class="line">// We handle 2 channels:</div><div class="line">// This array of all the outputs is in channel-number-order so RCRx knows which</div><div class="line">// Setter to call for each channel received. We define an array of 2 Setters for receiver channels 0 through 1</div><div class="line">#define NUM_OUTPUTS 2</div><div class="line">Setter*  outputs[NUM_OUTPUTS] = {&amp;di1, &amp;ds1};</div><div class="line"></div><div class="line">void setup()</div><div class="line">{</div><div class="line">  Serial.begin(9600);</div><div class="line">  while (!Serial) </div><div class="line">    ;</div><div class="line"></div><div class="line">  // Ensure the default value of the wheels is stopped</div><div class="line">  left.input(127);</div><div class="line">  right.input(127);</div><div class="line">  </div><div class="line">  // Tell the receiver where to send the 2 channels</div><div class="line">  rcrx.setOutputs((Setter**)&amp;outputs, NUM_OUTPUTS);</div><div class="line">  </div><div class="line">  // Join the transceiver and the RCRx receiver object together</div><div class="line">  rcrx.setTransceiver(&amp;transceiver);</div><div class="line"></div><div class="line">  // Initialise the receiver</div><div class="line">  rcrx.init();</div><div class="line">}</div><div class="line"></div><div class="line">unsigned long lastPollTime = 0;</div><div class="line">bool connected = false;</div><div class="line"></div><div class="line">void loop()</div><div class="line">{</div><div class="line">  // Do WiFi processing</div><div class="line">  rcrx.run();</div><div class="line">  </div><div class="line">  // See if its time to poll the Roomba</div><div class="line">  unsigned long time = millis();</div><div class="line">  if (time &gt; lastPollTime + 50)</div><div class="line">  {</div><div class="line">    lastPollTime = time;</div><div class="line">    </div><div class="line">    uint8_t buf[52]; </div><div class="line">    bool ret;    </div><div class="line">    if (!connected)</div><div class="line">    {</div><div class="line">        roomba.start();</div><div class="line">        roomba.fullMode();</div><div class="line">        roomba.drive(0, 0); // Stop</div><div class="line">        Serial.flush();</div><div class="line">        // Try to read a sensor. If that succeeds, we are connected</div><div class="line">        ret = roomba.getSensors(Roomba::SensorVoltage, buf, 2);</div><div class="line">        connected = ret;</div><div class="line">    }</div><div class="line">    else</div><div class="line">    {</div><div class="line">      // Connected</div><div class="line">      // Read all sensor data</div><div class="line">      // This can take up to 25 ms to complete</div><div class="line">      ret = roomba.getSensors(Roomba::Sensors7to42, buf, 52);</div><div class="line">      if (ret)</div><div class="line">      {</div><div class="line">        // got sensor data OK, so still connected</div><div class="line">        int32_t leftWheel, rightWheel;</div><div class="line"></div><div class="line">        // Could put some sensor logic here: stop the motors if </div><div class="line">        // we get a bump or  cliff? Go to home base if teh battery voltage is low?</div><div class="line">        // etc.</div><div class="line">        </div><div class="line">        // Compute the output wheel values from the left and right wheel values</div><div class="line">        // received from RCRx</div><div class="line">        leftWheel = left.lastValue();</div><div class="line">        leftWheel = ((-leftWheel + 127) * 500) / 127;</div><div class="line">        rightWheel = right.lastValue();</div><div class="line">        rightWheel = ((-rightWheel + 127) * 500) / 127;</div><div class="line">        // Make close to stopped into stopped</div><div class="line">        if (leftWheel &lt; 20 &amp;&amp; leftWheel &gt; -20)</div><div class="line">          leftWheel = 0;</div><div class="line">        if (rightWheel &lt; 20 &amp;&amp; rightWheel &gt; -20)</div><div class="line">          rightWheel = 0;</div><div class="line">        // Send the new values to the roomba</div><div class="line">        roomba.driveDirect(leftWheel, rightWheel);</div><div class="line">      }</div><div class="line">      else</div><div class="line">        connected = false;</div><div class="line">    }</div><div class="line">  }</div><div class="line">}</div><div class="line"></div><div class="line"></div></div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
